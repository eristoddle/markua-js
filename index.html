<html>
  <head>
    <title>Markua-JS</title>
    <script src="node_modules/babel-core/browser-polyfill.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.1.9/ace.js" type="text/javascript"></script>
    <script src="https://code.jquery.com/jquery-2.1.4.min.js" type="text/javascript"></script>
    <link href='http://fonts.googleapis.com/css?family=Lato:300,400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.3/normalize.css" />
    <link rel="stylesheet" href="build/main.css" />
  </head>
  <body>
    <section class="main">
      <h1 class="logo">Try out Markua</h1>
      <div class="content">
        <ul class="files list">

        </ul>
        <div id="editor" class="col"></div>
        <section id="output" class="col">
        </section>
      </div>
    </section>
    <script src="build/bundle.js" type="text/javascript"></script>
    <script>
      $(function() {
        filesToGet = [
          "book.txt",
          "manuscript/philosophy.txt",
          "manuscript/structure.txt",
          "manuscript/images.txt",
          "manuscript/block.txt",
          "manuscript/span.txt",
          "manuscript/whitespace.txt",
          "manuscript/metadata.txt",
          "manuscript/implementation.txt",
          "manuscript/appendices.txt",
          "manuscript/acknowledgments.txt"
        ]
        window.fileData = {}
        var currentFile = "/data/test_book/manuscript/philosophy.txt"
        setup = function() {
          output = function() {
            markua.run(function(error, result) {
              $("#output").html(result)
              $("#output img").each(function() {
                currentSrc = $(this).attr('src');
                if (!/http:|https:/.test(currentSrc))
                  $(this).attr('src', "/data/test_book/" + currentSrc);
              });
            });
          };

          editor = ace.edit('editor');
          editor.setTheme("ace/theme/xcode");
          editor.renderer.setShowGutter(false);
          editor.renderer.setPadding(20);
          editor.renderer.setScrollMargin(20);
          editor.setShowPrintMargin(false);
          editor.getSession().setMode("ace/mode/markdown");

          editor.setValue(window.fileData[currentFile], -1);
          editor.on("change", function(e) {
            window.fileData[currentFile] = editor.getValue()
            output()
          });

          output(editor.getValue());

          $(".files.list li a[data-target='" + currentFile + "']").parent().addClass("active")

          $(".files.list li a").on("click", function() {
            fileName = $(this).data("target")
            currentFile = fileName
            $(this).parent().siblings().removeClass('active')
            $(this).parent().addClass("active")
            editor.setValue(window.fileData[fileName], -1)
          });
        }

        onReceiveFile = function(contents) {
          // Take it away from what we need to get
          filesToGet.splice(filesToGet.indexOf(this.value), 1)

          $(".files.list").append("<li><a data-target='/data/test_book/" + this.value + "'>" + this.value + "</a></li>");

          // Stash the value of this file somewhere
          window.fileData["/data/test_book/" + this.value] = contents

          if (filesToGet.length === 0) {
            setup()
          }
        }

        // Once we've loaded the page, start loading our text data.
        for (fileIndex in filesToGet) {
          $.get("/data/test_book/" + filesToGet[fileIndex], onReceiveFile.bind({ value: filesToGet[fileIndex]}))
        }
      });
    </script>
  </body>
</html>
